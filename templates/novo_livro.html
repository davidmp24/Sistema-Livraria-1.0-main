{% extends "index.html" %}

{% block content %}
    <h1>Cadastrar Novo Livro</h1>

    <form action="{{ url_for('novo_livro') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="titulo">Título do Livro:</label>
            <div class="input-group">
                <input type="text" id="titulo" name="titulo" class="form-control" required>
                <button type="button" id="buscar-livro" class="btn btn-secondary">Buscar</button>
            </div>
        </div>

        <!-- Tabela de Resultados Oculta Inicialmente -->
        <div id="resultados-busca" style="display: none; margin-top: 20px;">
            <h3>Resultados da Busca</h3>
            <ul id="lista-resultados" class="list-group"></ul>
        </div>

        <div class="form-group">
            <label for="autor">Autor:</label>
            <input type="text" id="autor" name="autor" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="editora">Editora:</label>
            <input type="text" id="editora" name="editora" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="idade_leitura">Idade de Leitura Recomendada:</label>
            <input type="text" id="idade_leitura" name="idade_leitura" class="form-control">
        </div>

        <div class="form-group">
            <label for="isbn">ISBN:</label>
            <input type="text" id="isbn" name="isbn" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="ano">Ano de Publicação:</label>
            <input type="text" id="ano" name="ano" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="num_paginas">Número de Páginas:</label>
            <input type="number" id="num_paginas" name="num_paginas" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="valor">Valor (R$):</label>
            <input type="number" id="valor" name="valor" step="0.01" class="form-control" required>
        </div>

        <!-- Campo para upload da Capa do Livro -->
        <div class="form-group">
            <label for="capa_livro">Capa do Livro:</label>
            <input type="file" id="capa_livro" name="capa_livro" class="form-control-file">
        </div>

        <button type="submit" class="btn btn-success">Cadastrar Livro</button>
    </form>

    <!-- Importar biblioteca de jQuery (se necessário) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Função para buscar o título do livro usando a API do Google Books
        document.getElementById('buscar-livro').addEventListener('click', function() {
            var query = document.getElementById('titulo').value;

            // Se o campo de título não estiver vazio, faça a busca
            if (query) {
                fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${query}`)
                    .then(response => response.json())
                    .then(data => {
                        var resultadosBusca = document.getElementById('resultados-busca');
                        var listaResultados = document.getElementById('lista-resultados');
                        listaResultados.innerHTML = ''; // Limpar resultados anteriores

                        if (data.items && data.items.length > 0) {
                            // Exibe a tabela de resultados
                            resultadosBusca.style.display = 'block';

                            data.items.forEach(item => {
                                var listItem = document.createElement('li');
                                listItem.classList.add('list-group-item');

                                var info = item.volumeInfo;

                                listItem.innerHTML = `
                                    <strong>Título:</strong> ${info.title} <br>
                                    <strong>Autor:</strong> ${info.authors ? info.authors.join(', ') : 'Desconhecido'} <br>
                                    <strong>Ano:</strong> ${info.publishedDate || 'Desconhecido'} <br>
                                    <button type="button" class="selecionar-livro btn btn-primary mt-2" 
                                        data-titulo="${info.title}" 
                                        data-autor="${info.authors ? info.authors.join(', ') : ''}" 
                                        data-ano="${info.publishedDate || ''}">Selecionar</button>
                                `;
                                listaResultados.appendChild(listItem);
                            });
                        } else {
                            // Se não houver resultados, esconda a tabela e mostre uma mensagem
                            resultadosBusca.style.display = 'none';
                            alert('Nenhum resultado encontrado.');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar o livro:', error);
                        alert('Erro ao buscar o livro.');
                    });
            }
        });

        // Função para preencher os campos ao clicar em "Selecionar"
        document.getElementById('lista-resultados').addEventListener('click', function(event) {
            if (event.target.classList.contains('selecionar-livro')) {
                var titulo = event.target.getAttribute('data-titulo');
                var autor = event.target.getAttribute('data-autor');
                var ano = event.target.getAttribute('data-ano');

                // Preencher os campos do formulário com os dados selecionados
                document.getElementById('titulo').value = titulo;
                document.getElementById('autor').value = autor;
                document.getElementById('ano').value = ano;

                // Esconder os resultados após a seleção
                document.getElementById('resultados-busca').style.display = 'none';
            }
        });
    </script>
{% endblock %}
