{% extends "index.html" %}

{% block content %}
<h1>Controle de Vendas</h1>

<div class="vendas-container">
    <div class="row-container" style="display: flex; gap: 20px;">
        <div class="pesquisa-livro" style="flex: 1;">
            <form action="{{ url_for('vendas') }}" method="POST" id="vendaForm">
                <!-- Campo de ID do livro e botão de busca -->
                <div class="form-group" style="display: flex; align-items: center;">
                    <label for="livro_id" style="margin-right: 10px;">ID do Livro:</label>
                    <input type="number" id="livro_id" name="livro_id" class="form-control" style="width: 150px;" required>
                    <button type="submit" class="btn btn-primary" style="margin-left: 10px; height: 38px;">Buscar</button>
                </div>

                <!-- Novos campos para Título, Quantidade, Valor Total e Cliente -->
                {% if livro_info %}
                <div class="form-group mt-3">
                    <label for="titulo">Título:</label>
                    <input type="text" id="titulo" name="titulo" class="form-control" value="{{ livro_info.titulo }}" readonly>
                </div>

                <div class="form-group">
                    <label for="quantidade">Quantidade:</label>
                    <input type="number" id="quantidade" name="quantidade" class="form-control" min="1" max="{{ livro_info.estoque }}" value="1" oninput="calcularValorTotal()" required>
                    <div id="estoque-alert" class="alert alert-danger mt-2" style="display:none;">
                        Quantidade excedida! Estoque disponível: {{ livro_info.estoque }}.
                    </div>
                </div>

                <div class="form-group">
                    <label for="valor_total">Valor Total:</label>
                    <input type="text" id="valor_total" name="valor_total" class="form-control" value="R$ {{ livro_info.valor }}" readonly>
                </div>

                <!-- Campo para CPF ou Nome do Cliente -->
                <div class="form-group">
                    <label for="cliente_info">CPF ou Nome Completo do Cliente:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="cliente_info" name="cliente_info" class="form-control" placeholder="Digite CPF ou Nome" required>
                        <button type="button" class="btn btn-info" onclick="buscarCliente()">Buscar</button>
                    </div>
                    <ul id="resultado_busca" class="mt-2" style="list-style-type: none; padding: 0; display: none;"></ul>
                </div>

                <!-- Botão de confirmação de venda -->
                <button type="button" class="btn btn-success mt-3" onclick="confirmarVenda()">Confirmar</button>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<!-- Tabela de resultado da busca do livro -->
{% if livro_info %}
<div class="livro-result mt-4">
    <!-- Capa do livro -->
    <div class="livro-capa">
        <img src="{{ livro_info.capa }}" alt="Capa do Livro" class="livro-imagem">
    </div>

    <!-- Informações do livro ao lado da capa -->
    <div class="livro-info">
        <p><strong>Título:</strong> {{ livro_info.titulo }}</p>
        <p><strong>Autor:</strong> {{ livro_info.autor }}</p>
        <p><strong>Gênero:</strong> {{ livro_info.idade_leitura }}</p>
        <p><strong>Estoque:</strong> {{ livro_info.estoque }}</p>
        <p><strong>Valor:</strong> R$ {{ livro_info.valor }}</p>
    </div>
</div>
{% endif %}

<script>
    function calcularValorTotal() {
        const quantidade = parseInt(document.getElementById('quantidade').value);
        const estoque = {{ livro_info.estoque }};
        const valorUnitario = {{ livro_info.valor }};

        if (quantidade > estoque) {
            document.getElementById('estoque-alert').style.display = 'block';
            document.getElementById('valor_total').value = "R$ 0.00";
        } else {
            document.getElementById('estoque-alert').style.display = 'none';
            const valorTotal = quantidade * valorUnitario;
            document.getElementById('valor_total').value = "R$ " + valorTotal.toFixed(2);
        }
    }

    function buscarCliente() {
        const clienteInfo = document.getElementById('cliente_info').value;

        fetch(`/buscar_cliente?info=${clienteInfo}`)
            .then(response => response.json())
            .then(data => {
                const resultadoLista = document.getElementById('resultado_busca');
                resultadoLista.innerHTML = ""; // Limpa resultados anteriores
                if (data.success && data.clientes.length > 0) {
                    data.clientes.forEach(cliente => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${cliente.nome} - ${cliente.cpf}`;
                        resultadoLista.appendChild(listItem);
                    });
                    resultadoLista.style.display = 'block';
                } else {
                    resultadoLista.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar cliente:', error);
                alert("Erro ao buscar cliente.");
            });
    }

    function confirmarVenda() {
        const vendaForm = document.getElementById('vendaForm');
        const quantidade = parseInt(document.getElementById('quantidade').value);
        const estoque = {{ livro_info.estoque }};
        
        if (quantidade > estoque) {
            alert("Quantidade excedida!");
            return;
        }

        fetch('{{ url_for("confirmar_venda") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                livro_id: document.getElementById('livro_id').value,
                titulo: document.getElementById('titulo').value,
                quantidade: quantidade,
                valor_total: document.getElementById('valor_total').value,
                cliente_info: document.getElementById('cliente_info').value,
                data_hora: new Date().toISOString()  // Salva a data/hora atual em formato ISO
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Venda registrada com sucesso!");
                vendaForm.reset();
            } else {
                alert("Erro ao registrar a venda.");
            }
        })
        .catch(error => console.error('Erro:', error));
    }
</script>


{% endblock %}